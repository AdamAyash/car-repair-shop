USE[CarRepairShop]
GO

DROP TABLE IF EXISTS REPAIRS
GO

DROP TABLE IF EXISTS CLIENTS
GO

DROP TABLE IF EXISTS CARS
GO

DROP TABLE IF EXISTS BRANDS
GO

CREATE TABLE BRANDS
(
	ID		INT	IDENTITY(1,1)		NOT NULL,
	[NAME]	VARCHAR(32)				NOT NULL
	CONSTRAINT PK_BRAND_ID PRIMARY KEY(ID)
)
GO

CREATE UNIQUE INDEX UX_BRANDS_NAME
ON BRANDS
(
	[NAME]
)

DROP TABLE IF EXISTS MODELS
GO

CREATE TABLE MODELS
(
	ID		INT	IDENTITY(1,1)		NOT NULL,
	[NAME]	VARCHAR(32)				NOT NULL
	CONSTRAINT PK_MODEL_ID PRIMARY KEY(ID)
)
GO

CREATE UNIQUE INDEX UX_MODELS_NAME
ON MODELS
(
	[NAME]
)


CREATE TABLE CARS
(
	ID					INT	IDENTITY(1,1)		NOT NULL,
	REGISTRATION_NUMBER	VARCHAR(32)				NOT NULL,
	BRAND_ID			INT						NOT NULL,
	MODEL_ID			INT						NOT NULL,
	COLOR_ID			INT						NOT NULL,
	YEAR_OF_PRODUCTION	DATETIME				NOT NULL,
	NUMBER_OF_SEATS		INT						NOT NULL,
	REPAIR_PRICE		FLOAT					NOT NULL,
	CONSTRAINT PK_CARS_ID PRIMARY KEY(ID),
	CONSTRAINT FK_CARS_BRANDS_ID FOREIGN KEY(BRAND_ID)
	REFERENCES BRANDS(ID),
	CONSTRAINT FK_CARS_MODELS_ID FOREIGN KEY(MODEL_ID)
	REFERENCES MODELS(ID)
)
GO


DROP TABLE IF EXISTS CITIES
GO

CREATE TABLE CITIES
(
	ID		INT	IDENTITY(1,1)		NOT NULL,
	[NAME]	VARCHAR(32)				NOT NULL
	CONSTRAINT PK_CITIES_ID PRIMARY KEY(ID)
)
GO

CREATE UNIQUE INDEX UX_CITIES_NAME
ON CITIES
(
	[NAME]
)



CREATE TABLE CLIENTS
(
	ID				INT	IDENTITY(1,1)	NOT NULL,
	[NAME]			VARCHAR(64)			NOT NULL,
	IDENTITY_NUMBER	VARCHAR(32)			NOT NULL,
	CITY_ID			INT					NOT NULL,
	[ADDRESS]		VARCHAR(64)			NOT NULL,
	TELEPHONE		VARCHAR(16)			NOT NULL,
	CONSTRAINT PK_CLIENTS_ID PRIMARY KEY(ID),
	CONSTRAINT FK_CLIENTS_CITIES_ID FOREIGN KEY(CITY_ID)
	REFERENCES CITIES(ID)
)
GO

CREATE UNIQUE INDEX UX_CLIENTS_IDENTITY_NUMBER
ON CLIENTS
(
	IDENTITY_NUMBER
)



CREATE TABLE REPAIRS
(
	ID			INT IDENTITY(1,1)	NOT NULL,
	CLIENT_ID	INT					NOT NULL,
	CAR_ID		INT					NOT NULL,
	BEGIN_DATE	DATETIME			NOT NULL,
	END_DATE	DATETIME			NOT NULL,
	IS_PAYED	TINYINT				NOT NULL,
	IS_RETURNED TINYINT				NOT NULL
	CONSTRAINT PK_REPAIRS_ID PRIMARY KEY(ID),
	CONSTRAINT FK_REPAIRS_CLIENTS_ID FOREIGN KEY(CLIENT_ID)
	REFERENCES CLIENTS(ID),
	CONSTRAINT FK_REPAIRS_CARS_ID FOREIGN KEY(CAR_ID)
	REFERENCES CARS(ID)
)
GO


insert into BRANDS ( NAME) values ('Mazda');
insert into BRANDS ( NAME) values ('Daewoo');
insert into BRANDS ( NAME) values ('Mercury');
insert into BRANDS ( NAME) values ('Ford');
insert into BRANDS ( NAME) values ('Chevrolet');
insert into BRANDS ( NAME) values ('BMW');


insert into MODELS (NAME) values ('Legacy');
insert into MODELS (NAME) values ('GTI');
insert into MODELS (NAME) values ('Mulsanne');
insert into MODELS (NAME) values ('Sonata');
insert into MODELS (NAME) values ('Silverado 2500');



SELECT TOP 1
	CLIENTS.NAME,
	CLIENTS.IDENTITY_NUMBER,
	CARS.REGISTRATION_NUMBER,
	MAX(CARS.REPAIR_PRICE)  AS MAX_PRICE
FROM REPAIRS WITH(NOLOCK)
INNER JOIN CLIENTS WITH (NOLOCK)
	ON REPAIRS.CLIENT_ID = CLIENTS.ID
INNER JOIN CARS WITH (NOLOCK)
	ON CARS.ID = REPAIRS.CAR_ID
GROUP BY CLIENTS.NAME, CLIENTS.IDENTITY_NUMBER, CARS.REGISTRATION_NUMBER
ORDER BY MAX_PRICE DESC


SELECT TOP 3
	BRANDS.NAME,
	CLIENTS.NAME,
	CLIENTS.IDENTITY_NUMBER,
	CARS.REGISTRATION_NUMBER,
	COUNT(CARS.REGISTRATION_NUMBER) AS NUMBER_OF_REPAIRS,
	BRANDS.NAME
FROM REPAIRS WITH(NOLOCK)
INNER JOIN CLIENTS WITH (NOLOCK)
	ON REPAIRS.CLIENT_ID = CLIENTS.ID
INNER JOIN CARS WITH (NOLOCK)
	ON CARS.ID = REPAIRS.CAR_ID
INNER JOIN BRANDS WITH (NOLOCK)
	ON BRANDS.ID = CARS.BRAND_ID
GROUP BY CLIENTS.NAME, CLIENTS.IDENTITY_NUMBER, CARS.REGISTRATION_NUMBER, BRANDS.NAME
ORDER BY NUMBER_OF_REPAIRS DESC 

SELECT
	*
FROM CARS WITH(NOLOCK)
INNER JOIN REPAIRS WITH (NOLOCK)
	ON CARS.ID = REPAIRS.CAR_ID
WHERE REPAIRS.IS_PAYED = 1


SELECT
    REGISTRATION_NUMBER,
    BRANDS.NAME				AS BRAND_NAME,
    MIN(REPAIR_PRICE)		AS MINREPAIRPRICE,
    MAX(REPAIR_PRICE)		AS MAXREPAIRPRICE
FROM CARS WITH(NOLOCK)
INNER JOIN BRANDS WITH(NOLOCK)
	ON BRANDS.ID = CARS.ID
GROUP BY REGISTRATION_NUMBER,  BRANDS.NAME



